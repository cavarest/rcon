name: Integration Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'build.gradle'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'test/**'
      - 'build.gradle'
      - '.github/workflows/integration-tests.yml'

jobs:
  integration-test:
    runs-on: ubuntu-latest

    permissions:
      checks: write
      contents: read
      packages: read

    services:
      minecraft:
        image: papermc/paper:1.21.8
        ports:
          - 25565:25565
          - 25575:25575
        env:
          EULA: 'TRUE'
          ONLINE_MODE: 'false'
          SERVER_PORT: '25565'
          RCON_PORT: '25575'
          RCON_PASSWORD: cavarest
          MAX_PLAYERS: '5'
          MEMORY: 512M
        options: >-
          --health-cmd "echo 'list' | nc -w 3 localhost 25575 | grep -q 'Connected' || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 15
          --health-start-period 120s
          -e 'ACCEPT_EULA=TRUE'
          -e 'EULA=TRUE'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Wait for Minecraft server to be ready
      run: |
        echo "â³ Waiting for Minecraft server to start..."
        for i in {1..60}; do
          if echo 'list' | nc -w 3 localhost 25575 2>/dev/null | grep -q "Connected players"; then
            echo "âœ… Minecraft server is ready!"
            exit 0
          fi
          echo "Attempt $i: Waiting for server..."
          sleep 5
        done
        echo "âŒ Minecraft server did not start in time"
        exit 1

    - name: Verify RCON is accessible
      run: |
        echo "ðŸ”Œ Testing RCON connection..."
        echo '' | nc -w 3 localhost 25575
        if [ $? -eq 0 ]; then
          echo "âœ… RCON port is accessible"
        else
          echo "âš ï¸ RCON port may not be ready yet"
        fi

    - name: Build with Gradle
      run: |
        echo "ðŸ”¨ Compiling Java source code..."
        ./gradlew clean compileJava compileTestJava

    - name: Run unit tests first
      run: |
        echo "ðŸ§ª Running unit tests..."
        ./gradlew test

    - name: Run integration tests
      run: |
        echo "ðŸš€ Running integration tests..."
        echo "SKIP_INTEGRATION_TESTS=false" >> $GITHUB_ENV
        ./gradlew integrationTest --info 2>&1 | tee integration_test_output.log

    - name: Publish Integration Test Report
      if: success() || failure()
      uses: scacap/action-surefire-report@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        report_paths: '**/test-results/**/*.xml'
        check_name: Integration Test Report
        fail_on_test_failures: false
        fail_if_no_tests: false
        skip_publishing: false

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          build/test-results/
          build/reports/tests/test/
          integration_test_output.log
        retention-days: 30

    - name: Display integration test summary
      if: always()
      run: |
        echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f build/reports/tests/test/index.html ]; then
          echo "âœ… Integration tests completed. Check the test report for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No test report found." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Stop Minecraft server
      if: always()
      run: |
        echo "ðŸ›‘ Stopping Minecraft server container..."
        # The container will be stopped automatically when the job ends
        # This is just for cleanup visibility
        echo "Container will be cleaned up by GitHub Actions"
